name: Deploy to Staging/Production

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/web-app

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      METRICS_ROUTE_ALLOWLIST: "/health,/metrics,/api/posts,/api/messages,/api/analytics,/api/notifications,/api/search,/api/communities,/api/courses,/api/users"
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies (API)
        run: cd skool-clone/apps/api && npm ci
      
      - name: Install dependencies (Web)
        run: cd skool-clone/apps/web && npm ci
      
      - name: Run tests (API)
        run: cd skool-clone/apps/api && npm test
      
      - name: Run tests (Web)
        run: cd skool-clone/apps/web && npm test
      
      - name: Run linting
        run: |
          cd skool-clone/apps/api && npm run lint
          cd skool-clone/apps/web && npm run lint

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          file: skool-clone/Dockerfile.web  # Assume Dockerfile for web app

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    environment: 
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
      url: ${{ github.ref == 'refs/heads/main' && 'https://yourdomain.com' || 'https://staging.yourdomain.com' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_STAGING || secrets.KUBECONFIG_PROD }}" > ~/.kube/config

      - name: Update image in deployment
        env:
          ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Update Kubernetes deployment with new image tag
          kubectl set image deployment/web-app web-app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} -n ${{ env.ENVIRONMENT }}-namespace
          
          # Or use Helm upgrade if using Helm charts
          # helm upgrade web-app ./helm --set image.tag=${{ env.IMAGE_TAG }} --namespace ${{ env.ENVIRONMENT }}-namespace

      - name: Run database migrations
        run: |
          kubectl rollout restart deployment/web-app -n ${{ env.ENVIRONMENT }}-namespace
          # Run migrations via job or directly
          kubectl apply -f k8s/migration-job.yaml

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/web-app -n ${{ env.ENVIRONMENT }}-namespace --timeout=300s
          
          # Health check
          kubectl wait --for=condition=ready pod -l app=web-app -n ${{ env.ENVIRONMENT }}-namespace --timeout=300s

      - name: Notify on success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  rollback:
    needs: deploy
    runs-on: ubuntu-latest
    if: failure()  # Trigger on deploy failure
    environment: 
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_STAGING || secrets.KUBECONFIG_PROD }}" > ~/.kube/config

      - name: Rollback deployment
        env:
          ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
        run: |
          # Rollback to previous revision
          kubectl rollout undo deployment/web-app -n ${{ env.ENVIRONMENT }}-namespace
          
          # Verify rollback
          kubectl rollout status deployment/web-app -n ${{ env.ENVIRONMENT }}-namespace --timeout=300s

      - name: Notify rollback
        uses: 8398a7/action-slack@v3
        with:
          status: warning
          text: 'Deployment failed and rolled back automatically'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
